!function(e,o){"object"==typeof exports&&"object"==typeof module?module.exports=o():"function"==typeof define&&define.amd?define("activate",[],o):"object"==typeof exports?exports.activate=o():e.activate=o()}("undefined"!=typeof self?self:this,function(){return function(e){var o={};function n(t){if(o[t])return o[t].exports;var s=o[t]={i:t,l:!1,exports:{}};return e[t].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=e,n.c=o,n.d=function(e,o,t){n.o(e,o)||Object.defineProperty(e,o,{configurable:!1,enumerable:!0,get:t})},n.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(o,"a",o),o},n.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},n.p="",n(n.s=0)}([function(e,o,n){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.default=function(e,o,n){return{name:"GoogleIdpProxyProtoStub",instance:new c(e,o,n)}};var t=n(1),s=n(2),r=n(3),i=function(e){return e&&e.__esModule?e:{default:e}}(n(4));var c=function(e){function o(e,n,i){return function(e,o){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")}(this,o),i.domain="google.com",i.idpUrl="domain-idp://google.com",i.idpProxy=t.IdpProxy,i.idpInfo=s.googleInfo,i.apiInfo=s.googleAPIInfo,i.accessTokenAuthorisationEndpoint=s.accessTokenAuthorisationEndpoint,i.accessTokenEndpoint=s.accessTokenEndpoint,i.refreshAccessTokenEndpoint=s.refreshAccessTokenEndpoint,i.accessTokenInput=s.accessTokenInput,i.authorisationEndpoint=s.authorisationEndpoint,i.convertUserProfile=r.convertUserProfile,i.mapping=s.mapping,function(e,o){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!o||"object"!=typeof o&&"function"!=typeof o?e:o}(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e,n,i))}return function(e,o){if("function"!=typeof o&&null!==o)throw new TypeError("Super expression must either be null or a function, not "+typeof o);e.prototype=Object.create(o&&o.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),o&&(Object.setPrototypeOf?Object.setPrototypeOf(e,o):e.__proto__=o)}(o,i.default),o}()},function(e,o,n){"use strict";Object.defineProperty(o,"__esModule",{value:!0});var t={},s=0,r=location.protocol+"//"+location.hostname+(""!==location.port?":"+location.port:""),i=void 0,c=void 0,a=void 0,u=void 0,p=o.getExpiresAtJSON=function(e){var o=!!e.hasOwnProperty("expires_in")&&e.expires_in;return o?o+=Math.floor(Date.now()/1e3):o=31536e5+Math.floor(Date.now()/1e3),Number(o)},f=o.getExpires=function(e){var o=l(e,"expires_in");return o?o+=Math.floor(Date.now()/1e3):o=31536e5+Math.floor(Date.now()/1e3),Number(o)};function l(e,o){o=o.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var n=new RegExp("[\\#&?]"+o+"=([^&#]*)").exec(e);return null!==n&&n[1]}function d(e,o){var n=new XMLHttpRequest;return"withCredentials"in n?n.open(e,o,!0):"undefined"!=typeof XDomainRequest?(n=new XDomainRequest).open(e,o):n=null,new Promise(function(e,o){n?(n.onreadystatechange=function(t){if(4===n.readyState)if(200===n.status){var s=JSON.parse(n.responseText);e(s)}else 400===n.status?o("There was an error processing the token"):o("something else other than 200 was returned")},n.send()):o("CORS not supported")})}var g=function(e,o,n,t,s){var r={domain:a,resources:e,accessToken:o,expires:n,input:t};return s&&(r.refresh=s),r};o.IdpProxy={validateAssertion:function(e,o,n){console.info("[OIDC.validateAssertionProxy] assertion: ",atob(o));var t=atob(o),s=JSON.parse(t).tokenID.split(".");JSON.parse(atob(s[1]));return new Promise(function(n,t){var s=e.idpInfo,r=atob(o),i=JSON.parse(r);d("GET",s.tokenInfo+i.tokenID).then(function(e){JSON.stringify(e)===JSON.stringify(i.tokenIDJSON)?n({identity:i.tokenIDJSON.email,contents:i.tokenIDJSON}):t("invalid")}).catch(function(e){t(e)})})},refreshAssertion:function(e){return console.log("OIDC.refreshAssertion:oldIdentity",e),new Promise(function(o,n){o(e)})},generateAssertion:function(e,o,n,i){console.log("[OIDC.generateAssertion:contents]",o),console.log("[OIDC.generateAssertion:origin]",n),console.log("[OIDC.generateAssertion:hint]",i);var c=e.idpInfo;return new Promise(function(e,n){if(i){var a=l(i,"access_token"),u=l(i,"id_token");l(i,"code");d("GET",c.userinfo+a).then(function(o){console.log("[OIDC.generateAssertion] obtained infoToken ",o),d("GET",c.tokenInfo+u).then(function(n){console.log("[OIDC.generateAssertion] obtained idToken ",n);var r={assertion:btoa(JSON.stringify({tokenID:u,tokenIDJSON:n})),idp:{domain:c.domain,protocol:"OIDC"},expires:n.exp,userProfile:o,refresh:!0};t[s]=r,++s,console.log("[OIDC.generateAssertion] returning: ",JSON.stringify(r)),e(r)},function(e){n(e)})},function(e){n(e)})}else{var p=c.authorisationEndpoint+"redirect_uri="+r+"&prompt=consent&response_type="+c.type+"&client_id="+c.clientID+"&scope="+c.scope+"&access_type="+c.accessType+"&nonce="+o+"&state="+c.state;console.log("[OIDC.generateAssertion] NO_HINT: rejecting with requestUrl ",p),n({name:"IdPLoginError",loginUrl:p})}})},getAccessTokenAuthorisationEndpoint:function(e,o){console.log("[OIDC.getAccessTokenAuthorisationEndpoint:config]",e),console.log("[OIDC.getAccessTokenAuthorisationEndpoint:resources]",o),u=e.accessTokenAuthorisationEndpoint;var n=e.mapping;return new Promise(function(e,t){e(u(n(o)))},function(e){reject(e)})},getAccessToken:function(e,o,n){console.log("[OIDC.getAccessToken:config]",e),console.log("[OIDC.getAccessToken:login]",n),i=e.accessTokenEndpoint,a=e.domain;return new Promise(function(e,t){var s=f(n),r=l(n,"access_token");e(r?g(o,r,s,n):function(e,o){return new Promise(function(n,t){var s=l(o,"code");s||t("[OIDC.getAccessTokenWithCodeToken] code not include in the url: ",o),d("POST",i(s)).then(function(o){if(console.info("[OIDC.getAccessTokenWithCodeToken] response: ",o),o.hasOwnProperty("access_token")){var s=p(o),r=!!o.hasOwnProperty("refresh_token")&&o.refresh_token;n(g(e,o.access_token,s,o,r))}else t("[OIDC.getAccessTokenWithCodeToken] access token not returned in the exchange code result: ",o)},function(e){t(e)})})}(o,n))},function(e){reject(e)})},refreshAccessToken:function(e,o){console.log("[OIDC.refreshAccessToken:config]",e),console.log("[OIDC.refreshAccessToken:outdated token]",o),c=e.refreshAccessTokenEndpoint,a=e.domain;return new Promise(function(e,n){var t=o.refresh;t||n("[OIDC.refreshAccessToken] refresh token not available in the access token",o),d("POST",c(t)).then(function(s){if(console.info("[OIDC.refreshAccessToken] response: ",s),s.hasOwnProperty("access_token")){var r=p(s);e(g(o.resources,s.access_token,r,s,t))}else n("[OIDC.refreshAccessToken] new access token not returned in the response: ",s)},function(e){n(e)})},function(e){reject(e)})}}},function(e,o,n){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.accessTokenEndpoint=function(e){return s.tokenEndpoint+"client_id="+s.clientID+"&code="+e+"&grant_type=authorization_code&access_type=offline&client_secret="+s.secret+"&redirect_uri="+t},o.refreshAccessTokenEndpoint=function(e){return s.tokenEndpoint+"client_id="+s.clientID+"&refresh_token="+e+"&grant_type=refresh_token&client_secret="+s.secret},o.revokeAccessTokenEndpoint=function(e){return s.revokeEndpoint+"&token="+e},o.mapping=function(e){if(!e)return"fitness.location.read";switch(e){case"user_activity_context":default:return"fitness.location.read"}},o.accessTokenAuthorisationEndpoint=function(e){var o=s.authorisationEndpoint+"redirect_uri="+t+"&response_type="+s.type+"&client_id="+s.clientID+"&scope=https://www.googleapis.com/auth/"+e+"&access_type="+s.accessType+"&state="+s.state;return console.log("[GoogleInfo.accessTokenAuthorisationEndpoint] ",o),o},o.authorisationEndpoint=function(e){var o=s.authorisationEndpoint+"redirect_uri="+t+"&response_type="+s.type+"&client_id="+s.clientID+"&scope="+s.scope+"&access_type="+s.accessType+"&state="+e;return console.log("[GoogleInfo.authorisationEndpoint] ",o),o},o.accessTokenInput=function(e){return{info:e}};var t=location.protocol+"//"+location.hostname+(""!==location.port?":"+location.port:""),s=(o.googleInfo={clientID:"808329566012-tqr8qoh111942gd2kg007t0s8f277roi.apps.googleusercontent.com",issuer:"https://accounts.google.com",tokenEndpoint:"https://www.googleapis.com/oauth2/v4/token?",jwksUri:"https://www.googleapis.com/oauth2/v3/certs?",authorisationEndpoint:"https://accounts.google.com/o/oauth2/auth?",userinfo:"https://www.googleapis.com/oauth2/v3/userinfo?access_token=",tokenInfo:"https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=",accessType:"online",type:"token id_token",scope:"openid%20email%20profile",state:"state",domain:"google.com"},o.googleAPIInfo={clientID:"808329566012-tqr8qoh111942gd2kg007t0s8f277roi.apps.googleusercontent.com",issuer:"https://accounts.google.com",tokenEndpoint:"https://www.googleapis.com/oauth2/v4/token?",revokeEndpoint:"https://accounts.google.com/o/oauth2/revoke?",jwksUri:"https://www.googleapis.com/oauth2/v3/certs?",authorisationEndpoint:"https://accounts.google.com/o/oauth2/auth?",userinfo:"https://www.googleapis.com/oauth2/v3/userinfo?access_token=",tokenInfo:"https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=",accessType:"offline",type:"code",scope:"https://www.googleapis.com/auth/fitness.location.read",state:"state",domain:"google.com",grant_type:"authorization_code",secret:"Xx4rKucb5ZYTaXlcZX9HLfZW"})},function(e,o,n){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.convertUserProfile=function(e){e.userURL="user://google.com/"+e.email,e.hasOwnProperty("preferred_username")||(e.preferred_username=e.email.split("@")[0]);return e}},function(e,o,n){"use strict";Object.defineProperty(o,"__esModule",{value:!0});var t=function(){function e(e,o){for(var n=0;n<o.length;n++){var t=o[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(o,n,t){return n&&e(o.prototype,n),t&&e(o,t),o}}();var s=void 0,r=void 0,i=void 0,c=function(){function e(o,n,t){!function(e,o){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")}(this,e);var c=this;c.runtimeProtoStubURL=o,c.messageBus=n,c.config=t,s=t.idpProxy,r=t.convertUserProfile,i=t.accessTokenInput,console.log("[AbstractIdpProxy] constructor"),c.messageBus.addListener("*",function(e){e.to===t.idpUrl&&c.requestToIdp(e)}),c._sendStatus("created")}return t(e,[{key:"requestToIdp",value:function(e){var o=this,n=e.body.params;switch(console.info("[AbstractIdpProxyProtoStub] receiving request: ",e),e.body.method){case"generateAssertion":s.generateAssertion(o.config,n.contents,n.origin,n.usernameHint).then(function(n){n.userProfile=r(n.userProfile),o.replyMessage(e,n)},function(n){o.replyMessage(e,n,401)});break;case"validateAssertion":s.validateAssertion(o.config,n.assertion,n.origin).then(function(n){o.replyMessage(e,n)},function(n){o.replyMessage(e,n)});break;case"refreshAssertion":s.refreshAssertion(n.identity).then(function(n){o.replyMessage(e,n)},function(n){o.replyMessage(e,n,value,401)});break;case"getAccessTokenAuthorisationEndpoint":s.getAccessTokenAuthorisationEndpoint(o.config,n.resources).then(function(n){o.replyMessage(e,n)},function(n){o.replyMessage(e,n,401)});break;case"getAccessToken":s.getAccessToken(o.config,n.resources,n.login).then(function(n){console.info("OIDC.getAccessToken result: ",n),n.input=i(n.input),o.replyMessage(e,n)},function(n){o.replyMessage(e,n,401)});break;case"refreshAccessToken":s.refreshAccessToken(o.config,n.token).then(function(n){console.info("OIDC.refreshAccessToken result: ",n),o.replyMessage(e,n)},function(n){o.replyMessage(e,n,401)})}}},{key:"replyMessage",value:function(e,o){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:200,t={id:e.id,type:"response",to:e.from,from:e.to,body:{code:n}};n<300?t.body.value=o:t.body.description=o,console.log("[AbstractIdpProxyProtoStub.replyMessage] ",t),this.messageBus.postMessage(t)}},{key:"_sendStatus",value:function(e,o){console.log("[AbstractIdpProxyProtoStub.sendStatus] ",e),this._state=e;var n={type:"update",from:this.runtimeProtoStubURL,to:this.runtimeProtoStubURL+"/status",body:{value:e}};o&&(n.body.desc=o),this.messageBus.postMessage(n)}}]),e}();o.default=c}]).default});