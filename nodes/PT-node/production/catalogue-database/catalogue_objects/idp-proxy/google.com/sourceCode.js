!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("activate",[],t):"object"==typeof exports?exports.activate=t():e.activate=t()}("undefined"!=typeof self?self:this,function(){return function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}return o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=0)}([function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,o){return{name:"GoogleIdpProxyProtoStub",instance:new u(e,t,o)}};var n,r=o(1),s=o(2),i=o(3),a=o(4),c=(n=a)&&n.__esModule?n:{default:n};var u=function(e){function t(e,o,n){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),n.idpUrl="domain-idp://google.com",n.idpProxy=r.IdpProxy,n.idpInfo=s.googleInfo,n.convertUserProfile=i.convertUserProfile,function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,o,n))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,c.default),t}()},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n={},r=0,s=location.protocol+"//"+location.hostname+(""!==location.port?":"+location.port:"");function i(e,t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var o=new RegExp("[\\#&?]"+t+"=([^&#]*)").exec(e);return null===o?"":o[1]}function a(e,t){var o=new XMLHttpRequest;return"withCredentials"in o?o.open(e,t,!0):"undefined"!=typeof XDomainRequest?(o=new XDomainRequest).open(e,t):o=null,new Promise(function(e,t){o?(o.onreadystatechange=function(n){if(4===o.readyState)if(200===o.status){var r=JSON.parse(o.responseText);e(r)}else 400===o.status?t("There was an error processing the token"):t("something else other than 200 was returned")},o.send()):t("CORS not supported")})}t.IdpProxy={validateAssertion:function(e,t,o){console.info("[OIDC.validateAssertionProxy] assertion: ",atob(t));var n=atob(t),r=JSON.parse(n).tokenID.split(".");JSON.parse(atob(r[1]));return new Promise(function(o,n){var r=e.idpInfo,s=atob(t),i=JSON.parse(s);a("GET",r.tokenInfo+i.tokenID).then(function(e){JSON.stringify(e)===JSON.stringify(i.tokenIDJSON)?o({identity:i.tokenIDJSON.email,contents:i.tokenIDJSON}):n("invalid")}).catch(function(e){n(e)})})},generateAssertion:function(e,t,o,c){console.log("[OIDC.generateAssertion:contents]",t),console.log("[OIDC.generateAssertion:origin]",o),console.log("[OIDC.generateAssertion:hint]",c);var u=e.idpInfo;return new Promise(function(e,o){if(c){var l=i(c,"access_token"),f=i(c,"id_token");i(c,"code");a("GET",u.userinfo+l).then(function(t){console.log("[OIDC.generateAssertion] obtained infoToken ",t),a("GET",u.tokenInfo+f).then(function(o){console.log("[OIDC.generateAssertion] obtained idToken ",o);var s={assertion:btoa(JSON.stringify({tokenID:f,tokenIDJSON:o})),idp:{domain:u.domain,protocol:"OIDC"},expires:o.exp,userProfile:t};n[r]=s,++r,console.log("[OIDC.generateAssertion] returning: ",JSON.stringify(s)),e(s)},function(e){o(e)})},function(e){o(e)})}else{var p=u.authorisationEndpoint+"redirect_uri="+s+"&prompt=consent&response_type="+u.type+"&client_id="+u.clientID+"&scope="+u.scope+"&access_type="+u.accessType+"&nonce="+t+"&state="+u.state;console.log("[OIDC.generateAssertion] NO_HINT: rejecting with requestUrl ",p),o({name:"IdPLoginError",loginUrl:p})}})}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.googleInfo={clientID:"808329566012-tqr8qoh111942gd2kg007t0s8f277roi.apps.googleusercontent.com",issuer:"https://accounts.google.com",tokenEndpoint:"https://www.googleapis.com/oauth2/v4/token?",jwksUri:"https://www.googleapis.com/oauth2/v3/certs?",authorisationEndpoint:"https://accounts.google.com/o/oauth2/auth?",userinfo:"https://www.googleapis.com/oauth2/v3/userinfo?access_token=",tokenInfo:"https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=",accessType:"online",type:"token id_token",scope:"openid%20email%20profile",state:"state",domain:"google.com"}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.convertUserProfile=function(e){e.userURL="user://google.com/"+e.email,e.hasOwnProperty("preferred_username")||(e.preferred_username=e.email.split("@")[0]);return e}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,o,n){return o&&e(t.prototype,o),n&&e(t,n),t}}();var r=void 0,s=void 0,i=void 0,a=function(){function e(t,o,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var a=this;a.runtimeProtoStubURL=t,a.messageBus=o,a.config=n,r=n.idpProxy,s=n.convertUserProfile,i=n.accessTokenInput,console.log("[AbstractIdpProxy] constructor"),a.messageBus.addListener("*",function(e){e.to===n.idpUrl&&a.requestToIdp(e)}),a._sendStatus("created")}return n(e,[{key:"requestToIdp",value:function(e){var t=this,o=e.body.params;switch(console.info("[AbstractIdpProxyProtoStub] receiving request: ",e),e.body.method){case"generateAssertion":r.generateAssertion(t.config,o.contents,o.origin,o.usernameHint).then(function(o){o.userProfile=s(o.userProfile),t.replyMessage(e,o)},function(o){t.replyMessage(e,o)});break;case"validateAssertion":r.validateAssertion(t.config,o.assertion,o.origin).then(function(o){t.replyMessage(e,o)},function(o){t.replyMessage(e,o)});break;case"refreshAssertion":r.refreshAssertion(o.identity).then(function(o){t.replyMessage(e,o)},function(o){t.replyMessage(e,o)});break;case"getAccessTokenAuthorisationEndpoint":r.getAccessTokenAuthorisationEndpoint(t.config,o.resources).then(function(o){t.replyMessage(e,o)},function(o){t.replyMessage(e,o)});break;case"getAccessToken":r.getAccessToken(t.config,o.resources,o.login).then(function(o){o.input=i(o.input),t.replyMessage(e,o)},function(o){t.replyMessage(e,o)})}}},{key:"replyMessage",value:function(e,t){var o={id:e.id,type:"response",to:e.from,from:e.to,body:{code:200,value:t}};console.log("[AbstractIdpProxyProtoStub.replyMessage] ",o),this.messageBus.postMessage(o)}},{key:"_sendStatus",value:function(e,t){console.log("[AbstractIdpProxyProtoStub.sendStatus] ",e),this._state=e;var o={type:"update",from:this.runtimeProtoStubURL,to:this.runtimeProtoStubURL+"/status",body:{value:e}};t&&(o.body.desc=t),this.messageBus.postMessage(o)}}]),e}();t.default=a}]).default});