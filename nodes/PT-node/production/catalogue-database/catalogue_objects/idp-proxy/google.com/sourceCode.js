!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("activate",[],t):"object"==typeof exports?exports.activate=t():e.activate=t()}(this,function(){return function(e){function t(o){if(n[o])return n[o].exports;var r=n[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,o){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:o})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var n="[\\#&?]"+t+"=([^&#]*)",o=RegExp(n),r=o.exec(e);return null===r?"":r[1]}function i(e,t){var n=new XMLHttpRequest;return"withCredentials"in n?n.open(e,t,!0):"undefined"!=typeof XDomainRequest?(n=new XDomainRequest,n.open(e,t)):n=null,new Promise(function(e,t){n?(n.onreadystatechange=function(o){if(4===n.readyState)if(200===n.status){var r=JSON.parse(n.responseText);e(r)}else t(400===n.status?"There was an error processing the token":"something else other than 200 was returned")},n.send()):t("CORS not supported")})}function s(e,t,n){return{name:"IdpProxyProtoStub",instance:new g(e,t,n)}}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;t.length>n;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();t.default=s;var c={},u=0,f={clientSecret:"Xx4rKucb5ZYTaXlcZX9HLfZW",clientID:"808329566012-tqr8qoh111942gd2kg007t0s8f277roi.apps.googleusercontent.com",redirectURI:location.protocol+"//"+location.hostname,issuer:"https://accounts.google.com",tokenEndpoint:"https://www.googleapis.com/oauth2/v4/token?",jwksUri:"https://www.googleapis.com/oauth2/v3/certs?",authorisationEndpoint:"https://accounts.google.com/o/oauth2/auth?",userinfo:"https://www.googleapis.com/oauth2/v3/userinfo?access_token=",tokenInfo:"https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=",accessType:"offline",type:"code token id_token",scope:"openid%20email%20profile",state:"state"},p=function(e){var t=f,n=t.tokenEndpoint+"code="+e+"&client_id="+t.clientID+"&client_secret="+t.clientSecret+"&redirect_uri="+t.redirectURI+"&grant_type=authorization_code&access_type="+t.accessType;return new Promise(function(e,t){i("POST",n).then(function(t){e(t)},function(e){t(e)})})},l=function(e){var t=f,n=t.tokenEndpoint+"client_id="+t.clientID+"&client_secret="+t.clientSecret+"&refresh_token="+e+"&grant_type=refresh_token";return new Promise(function(e,t){i("POST",n).then(function(t){e(t)},function(e){t(e)})})},d={validateAssertion:function(e,t){return new Promise(function(t,n){var o=atob(e),r=JSON.parse(o),i=r.tokenID.split("."),s=JSON.parse(atob(i[1]));t({identity:s.email,contents:s.nonce})})},refreshAssertion:function(e){var t=f;return new Promise(function(n,o){e.info.refreshToken&&l(e.info.refreshToken).then(function(o){i("GET",t.userinfo+o.access_token).then(function(r){var s={accessToken:o.access_token,idToken:o.id_token,refreshToken:e.info.refreshToken,tokenType:e.info.tokenType,infoToken:r};i("GET",t.tokenInfo+o.id_token).then(function(t){s.tokenIDJSON=t,s.expires=t.exp,s.email=t.email;var i=JSON.parse(atob(e.assertion)),a=i.tokenID.split("."),c=JSON.parse(atob(a[1])),u=c.nonce,f=o.id_token,p=f.split("."),l=JSON.parse(atob(p[1]));l.nonce=u;var d=btoa(JSON.stringify(l)),g=p[0]+"."+d+"."+p[2],k=btoa(JSON.stringify({tokenID:g,tokenIDJSON:t}));n({assertion:k,idp:{domain:"google.com",protocol:"OIDC"},info:s,infoToken:r})})})})})},generateAssertion:function(e,t,n){var o=f;return new Promise(function(t,s){if(n){var a=(r(n,"access_token"),r(n,"id_token"),r(n,"code"));p(a).then(function(e){i("GET",o.userinfo+e.access_token).then(function(n){var r={accessToken:e.access_token,idToken:e.id_token,refreshToken:e.refresh_token,tokenType:e.token_type,infoToken:n};i("GET",o.tokenInfo+e.id_token).then(function(o){r.tokenIDJSON=o,r.expires=o.exp,r.email=o.email;var i=btoa(JSON.stringify({tokenID:e.id_token,tokenIDJSON:o})),s={domain:"google.com",protocol:"OIDC"},a={assertion:i,idp:s,info:r,infoToken:n};c[u]=a,++u,t(a)},function(e){s(e)})},function(e){s(e)})},function(e){s(e)})}else{s({name:"IdPLoginError",loginUrl:o.authorisationEndpoint+"scope="+o.scope+"&client_id="+o.clientID+"&redirect_uri="+o.redirectURI+"&response_type=code&state="+o.state+"&prompt=consent&access_type="+o.accessType+"&nonce="+e})}})}},g=function(){function e(t,n,r){o(this,e);var i=this;i.runtimeProtoStubURL=t,i.messageBus=n,i.config=r,console.log("[Google IdpProxy] starting",t),i.messageBus.addListener("*",function(e){"domain-idp://google.com"===e.to&&i.requestToIdp(e)}),i._sendStatus("created")}return a(e,[{key:"requestToIdp",value:function(e){var t=this,n=e.body.params;switch(e.body.method){case"generateAssertion":d.generateAssertion(n.contents,n.origin,n.usernameHint).then(function(n){t.replyMessage(e,n)},function(n){t.replyMessage(e,n)});break;case"validateAssertion":d.validateAssertion(n.assertion,n.origin).then(function(n){t.replyMessage(e,n)},function(n){t.replyMessage(e,n)});break;case"refreshAssertion":d.refreshAssertion(n.identity).then(function(n){t.replyMessage(e,n)},function(n){t.replyMessage(e,n)})}}},{key:"replyMessage",value:function(e,t){this.messageBus.postMessage({id:e.id,type:"response",to:e.from,from:e.to,body:{code:200,value:t}})}},{key:"_sendStatus",value:function(e,t){var n=this;console.log("[GoogleIdpProxy.sendStatus] ",e),n._state=e;var o={type:"update",from:n.runtimeProtoStubURL,to:n.runtimeProtoStubURL+"/status",body:{value:e}};t&&(o.body.desc=t),n.messageBus.postMessage(o)}}]),e}()}]).default});