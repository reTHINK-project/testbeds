!function(e,o){"object"==typeof exports&&"object"==typeof module?module.exports=o():"function"==typeof define&&define.amd?define("activate",[],o):"object"==typeof exports?exports.activate=o():e.activate=o()}("undefined"!=typeof self?self:this,function(){return function(e){var o={};function t(n){if(o[n])return o[n].exports;var s=o[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,t),s.l=!0,s.exports}return t.m=e,t.c=o,t.d=function(e,o,n){t.o(e,o)||Object.defineProperty(e,o,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(o,"a",o),o},t.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},t.p="",t(t.s=0)}([function(e,o,t){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.default=function(e,o,t){return{name:"GoogleIdpProxyProtoStub",instance:new c(e,o,t)}};var n=t(1),s=t(2),r=t(3),i=function(e){return e&&e.__esModule?e:{default:e}}(t(4));var c=function(e){function o(e,t,i){return function(e,o){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")}(this,o),i.domain="google.com",i.idpUrl="domain-idp://google.com",i.idpProxy=n.IdpProxy,i.idpInfo=s.googleInfo,i.apiInfo=s.googleAPIInfo,i.accessTokenAuthorisationEndpoint=s.accessTokenAuthorisationEndpoint,i.accessTokenEndpoint=s.accessTokenEndpoint,i.refreshAccessTokenEndpoint=s.refreshAccessTokenEndpoint,i.accessTokenInput=s.accessTokenInput,i.authorisationEndpoint=s.authorisationEndpoint,i.convertUserProfile=r.convertUserProfile,i.mapping=s.mapping,function(e,o){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!o||"object"!=typeof o&&"function"!=typeof o?e:o}(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e,t,i))}return function(e,o){if("function"!=typeof o&&null!==o)throw new TypeError("Super expression must either be null or a function, not "+typeof o);e.prototype=Object.create(o&&o.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),o&&(Object.setPrototypeOf?Object.setPrototypeOf(e,o):e.__proto__=o)}(o,i.default),o}()},function(e,o,t){"use strict";Object.defineProperty(o,"__esModule",{value:!0});var n={},s=0,r=location.protocol+"//"+location.hostname+(""!==location.port?":"+location.port:""),i=void 0,c=void 0,a=void 0,u=void 0,p=o.getExpiresAtJSON=function(e){var o=!!e.hasOwnProperty("expires_in")&&e.expires_in;return o?o+=Math.floor(Date.now()/1e3):o=31536e5+Math.floor(Date.now()/1e3),Number(o)},f=o.getExpires=function(e){var o=l(e,"expires_in");return o?o+=Math.floor(Date.now()/1e3):o=31536e5+Math.floor(Date.now()/1e3),Number(o)};function l(e,o){o=o.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\#&?]"+o+"=([^&#]*)").exec(e);return null!==t&&t[1]}function d(e,o){var t=new XMLHttpRequest;return"withCredentials"in t?t.open(e,o,!0):"undefined"!=typeof XDomainRequest?(t=new XDomainRequest).open(e,o):t=null,new Promise(function(e,o){t?(t.onreadystatechange=function(n){if(4===t.readyState)if(200===t.status){var s=JSON.parse(t.responseText);e(s)}else 400===t.status?o("There was an error processing the token"):o("something else other than 200 was returned")},t.send()):o("CORS not supported")})}var g=function(e,o,t,n,s){var r={domain:a,resources:e,accessToken:o,expires:t,input:n};return s&&(r.refresh=s),r};o.IdpProxy={validateAssertion:function(e,o,t){console.info("[OIDC.validateAssertionProxy] assertion: ",atob(o));var n=atob(o),s=JSON.parse(n).tokenID.split(".");JSON.parse(atob(s[1]));return new Promise(function(t,n){var s=e.idpInfo,r=atob(o),i=JSON.parse(r);d("GET",s.tokenInfo+i.tokenID).then(function(e){JSON.stringify(e)===JSON.stringify(i.tokenIDJSON)?t({identity:i.tokenIDJSON.email,contents:i.tokenIDJSON}):n("invalid")}).catch(function(e){n(e)})})},refreshAssertion:function(e){return console.log("PROXY:refreshAssertion:oldIdentity",e),new Promise(function(o,t){o(e)})},generateAssertion:function(e,o,t,i){console.log("[OIDC.generateAssertion:contents]",o),console.log("[OIDC.generateAssertion:origin]",t),console.log("[OIDC.generateAssertion:hint]",i);var c=e.idpInfo;return new Promise(function(e,t){if(i){var a=l(i,"access_token"),u=l(i,"id_token");l(i,"code");d("GET",c.userinfo+a).then(function(o){console.log("[OIDC.generateAssertion] obtained infoToken ",o),d("GET",c.tokenInfo+u).then(function(t){console.log("[OIDC.generateAssertion] obtained idToken ",t);var r={assertion:btoa(JSON.stringify({tokenID:u,tokenIDJSON:t})),idp:{domain:c.domain,protocol:"OIDC"},expires:t.exp,userProfile:o,refresh:!0};n[s]=r,++s,console.log("[OIDC.generateAssertion] returning: ",JSON.stringify(r)),e(r)},function(e){t(e)})},function(e){t(e)})}else{var p=c.authorisationEndpoint+"redirect_uri="+r+"&prompt=consent&response_type="+c.type+"&client_id="+c.clientID+"&scope="+c.scope+"&access_type="+c.accessType+"&nonce="+o+"&state="+c.state;console.log("[OIDC.generateAssertion] NO_HINT: rejecting with requestUrl ",p),t({name:"IdPLoginError",loginUrl:p})}})},getAccessTokenAuthorisationEndpoint:function(e,o){console.log("[OIDC.getAccessTokenAuthorisationEndpoint:config]",e),console.log("[OIDC.getAccessTokenAuthorisationEndpoint:resources]",o),u=e.accessTokenAuthorisationEndpoint;var t=e.mapping;return new Promise(function(e,n){e(u(t(o)))},function(e){reject(e)})},getAccessToken:function(e,o,t){console.log("[OIDC.getAccessToken:config]",e),console.log("[OIDC.getAccessToken:login]",t),i=e.accessTokenEndpoint,a=e.domain;return new Promise(function(e,n){var s=f(t),r=l(t,"access_token");e(r?g(o,r,s,t):function(e,o){return new Promise(function(t,n){var s=l(o,"code");s||n("[OIDC.getAccessTokenWithCodeToken] code not include in the url: ",o),d("POST",i(s)).then(function(o){if(console.info("[OIDC.getAccessTokenWithCodeToken] response: ",o),o.hasOwnProperty("access_token")){var s=p(o),r=!!o.hasOwnProperty("refresh_token")&&o.refresh_token;t(g(e,o.access_token,s,o,r))}else n("[OIDC.getAccessTokenWithCodeToken] access token not returned in the exchange code result: ",o)},function(e){n(e)})})}(o,t))},function(e){reject(e)})},refreshAccessToken:function(e,o){console.log("[OIDC.refreshAccessToken:config]",e),console.log("[OIDC.refreshAccessToken:outdated token]",o),c=e.refreshAccessTokenEndpoint,a=e.domain;return new Promise(function(e,t){var n=o.refresh;n||t("[OIDC.refreshAccessToken] refresh token not available in the access token",o),d("POST",c(n)).then(function(s){if(console.info("[OIDC.refreshAccessToken] response: ",s),s.hasOwnProperty("access_token")){var r=p(s);e(g(o.resources,s.access_token,r,s,n))}else t("[OIDC.refreshAccessToken] new access token not returned in the response: ",s)},function(e){t(e)})},function(e){reject(e)})}}},function(e,o,t){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.accessTokenEndpoint=function(e){return s.tokenEndpoint+"client_id="+s.clientID+"&code="+e+"&grant_type=authorization_code&access_type=offline&client_secret="+s.secret+"&redirect_uri="+n},o.refreshAccessTokenEndpoint=function(e){return s.tokenEndpoint+"client_id="+s.clientID+"&refresh_token="+e+"&grant_type=refresh_token&client_secret="+s.secret},o.revokeAccessTokenEndpoint=function(e){return s.revokeEndpoint+"&token="+e},o.mapping=function(e){if(!e)return"fitness.activity.read";switch(e){case"user_activity_context":default:return"fitness.activity.read"}},o.accessTokenAuthorisationEndpoint=function(e){var o=s.authorisationEndpoint+"redirect_uri="+n+"&response_type="+s.type+"&client_id="+s.clientID+"&scope=https://www.googleapis.com/auth/"+e+"&access_type="+s.accessType+"&state="+s.state;return console.log("[GoogleInfo.accessTokenAuthorisationEndpoint] ",o),o},o.authorisationEndpoint=function(e){var o=s.authorisationEndpoint+"redirect_uri="+n+"&response_type="+s.type+"&client_id="+s.clientID+"&scope="+s.scope+"&access_type="+s.accessType+"&state="+e;return console.log("[GoogleInfo.authorisationEndpoint] ",o),o},o.accessTokenInput=function(e){return{info:e}};var n=location.protocol+"//"+location.hostname+(""!==location.port?":"+location.port:""),s=(o.googleInfo={clientID:"808329566012-tqr8qoh111942gd2kg007t0s8f277roi.apps.googleusercontent.com",issuer:"https://accounts.google.com",tokenEndpoint:"https://www.googleapis.com/oauth2/v4/token?",jwksUri:"https://www.googleapis.com/oauth2/v3/certs?",authorisationEndpoint:"https://accounts.google.com/o/oauth2/auth?",userinfo:"https://www.googleapis.com/oauth2/v3/userinfo?access_token=",tokenInfo:"https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=",accessType:"online",type:"token id_token",scope:"openid%20email%20profile",state:"state",domain:"google.com"},o.googleAPIInfo={clientID:"808329566012-tqr8qoh111942gd2kg007t0s8f277roi.apps.googleusercontent.com",issuer:"https://accounts.google.com",tokenEndpoint:"https://www.googleapis.com/oauth2/v4/token?",revokeEndpoint:"https://accounts.google.com/o/oauth2/revoke?",jwksUri:"https://www.googleapis.com/oauth2/v3/certs?",authorisationEndpoint:"https://accounts.google.com/o/oauth2/auth?",userinfo:"https://www.googleapis.com/oauth2/v3/userinfo?access_token=",tokenInfo:"https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=",accessType:"offline",type:"code",scope:"https://www.googleapis.com/auth/fitness.activity.read",state:"state",domain:"google.com",grant_type:"authorization_code",secret:"Xx4rKucb5ZYTaXlcZX9HLfZW"})},function(e,o,t){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.convertUserProfile=function(e){e.userURL="user://google.com/"+e.email,e.hasOwnProperty("preferred_username")||(e.preferred_username=e.email.split("@")[0]);return e}},function(e,o,t){"use strict";Object.defineProperty(o,"__esModule",{value:!0});var n=function(){function e(e,o){for(var t=0;t<o.length;t++){var n=o[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(o,t,n){return t&&e(o.prototype,t),n&&e(o,n),o}}();var s=void 0,r=void 0,i=void 0,c=function(){function e(o,t,n){!function(e,o){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")}(this,e);var c=this;c.runtimeProtoStubURL=o,c.messageBus=t,c.config=n,s=n.idpProxy,r=n.convertUserProfile,i=n.accessTokenInput,console.log("[AbstractIdpProxy] constructor"),c.messageBus.addListener("*",function(e){e.to===n.idpUrl&&c.requestToIdp(e)}),c._sendStatus("created")}return n(e,[{key:"requestToIdp",value:function(e){var o=this,t=e.body.params;switch(console.info("[AbstractIdpProxyProtoStub] receiving request: ",e),e.body.method){case"generateAssertion":s.generateAssertion(o.config,t.contents,t.origin,t.usernameHint).then(function(t){t.userProfile=r(t.userProfile),o.replyMessage(e,t)},function(t){o.replyMessage(e,t)});break;case"validateAssertion":s.validateAssertion(o.config,t.assertion,t.origin).then(function(t){o.replyMessage(e,t)},function(t){o.replyMessage(e,t)});break;case"refreshAssertion":s.refreshAssertion(t.identity).then(function(t){o.replyMessage(e,t)},function(t){o.replyMessage(e,t)});break;case"getAccessTokenAuthorisationEndpoint":s.getAccessTokenAuthorisationEndpoint(o.config,t.resources).then(function(t){o.replyMessage(e,t)},function(t){o.replyMessage(e,t)});break;case"getAccessToken":s.getAccessToken(o.config,t.resources,t.login).then(function(t){console.info("OIDC.getAccessToken result: ",t),t.input=i(t.input),o.replyMessage(e,t)},function(t){o.replyMessage(e,t)});break;case"refreshAccessToken":s.refreshAccessToken(o.config,t.token).then(function(t){console.info("OIDC.refreshAccessToken result: ",t),o.replyMessage(e,t)},function(t){o.replyMessage(e,t)})}}},{key:"replyMessage",value:function(e,o){var t={id:e.id,type:"response",to:e.from,from:e.to,body:{code:200,value:o}};console.log("[AbstractIdpProxyProtoStub.replyMessage] ",t),this.messageBus.postMessage(t)}},{key:"_sendStatus",value:function(e,o){console.log("[AbstractIdpProxyProtoStub.sendStatus] ",e),this._state=e;var t={type:"update",from:this.runtimeProtoStubURL,to:this.runtimeProtoStubURL+"/status",body:{value:e}};o&&(t.body.desc=o),this.messageBus.postMessage(t)}}]),e}();o.default=c}]).default});