!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define("activate",[],n):"object"==typeof exports?exports.activate=n():e.activate=n()}("undefined"!=typeof self?self:this,function(){return function(e){function n(t){if(o[t])return o[t].exports;var i=o[t]={i:t,l:!1,exports:{}};return e[t].call(i.exports,i,i.exports,n),i.l=!0,i.exports}var o={};return n.m=e,n.c=o,n.d=function(e,o,t){n.o(e,o)||Object.defineProperty(e,o,{configurable:!1,enumerable:!0,get:t})},n.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(o,"a",o),o},n.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},n.p="",n(n.s=0)}([function(e,n,o){"use strict";function t(e,n){var o="[\\#&?]"+(n=n.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"))+"=([^&#]*)",t=new RegExp(o).exec(e);return null===t?"":t[1]}function i(e,n){var o=new XMLHttpRequest;return"withCredentials"in o?o.open(e,n,!0):"undefined"!=typeof XDomainRequest?(o=new XDomainRequest).open(e,n):o=null,new Promise(function(e,n){o?(o.onreadystatechange=function(t){if(4===o.readyState)if(200===o.status){var i=JSON.parse(o.responseText);e(i)}else n(400===o.status?"There was an error processing the token":"something else other than 200 was returned")},o.send()):n("CORS not supported")})}Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,n){for(var o=0;o<n.length;o++){var t=n[o];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(n,o,t){return o&&e(n.prototype,o),t&&e(n,t),n}}();n.default=function(e,n,o){return{name:"IdpProxyProtoStub",instance:new p(e,n,o)}};var s={},a=0,c={clientSecret:"Xx4rKucb5ZYTaXlcZX9HLfZW",clientID:"808329566012-tqr8qoh111942gd2kg007t0s8f277roi.apps.googleusercontent.com",redirectURI:location.protocol+"//"+location.hostname,issuer:"https://accounts.google.com",tokenEndpoint:"https://www.googleapis.com/oauth2/v4/token?",jwksUri:"https://www.googleapis.com/oauth2/v3/certs?",authorisationEndpoint:"https://accounts.google.com/o/oauth2/auth?",userinfo:"https://www.googleapis.com/oauth2/v3/userinfo?access_token=",tokenInfo:"https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=",accessType:"offline",type:"code token id_token",scope:"openid%20email%20profile",state:"state"},u=function(e,n){console.info("validateAssertionProxy"),console.info("validateAssertionProxy:atob(assertion)",atob(e));var o=atob(e),t=JSON.parse(o).tokenID.split(".");JSON.parse(atob(t[1]));return new Promise(function(n,o){var t=c,r=atob(e),s=JSON.parse(r);i("GET",t.tokenInfo+s.tokenID).then(function(e){JSON.stringify(e)===JSON.stringify(s.tokenIDJSON)?n({identity:s.tokenIDJSON.email,contents:s.tokenIDJSON}):o("invalid")}).catch(function(e){o(e)})})},f=function(e){var n=c;return new Promise(function(o,t){e.info.refreshToken&&function(e){var n=c.tokenEndpoint+"client_id="+c.clientID+"&client_secret="+c.clientSecret+"&refresh_token="+e+"&grant_type=refresh_token";return new Promise(function(e,o){i("POST",n).then(function(n){e(n)},function(e){o(e)})})}(e.info.refreshToken).then(function(t){i("GET",n.userinfo+t.access_token).then(function(r){var s={accessToken:t.access_token,idToken:t.id_token,refreshToken:e.info.refreshToken,tokenType:e.info.tokenType,infoToken:r};i("GET",n.tokenInfo+t.id_token).then(function(n){s.tokenIDJSON=n,s.expires=n.exp,s.email=n.email;var i=JSON.parse(atob(e.assertion)).tokenID.split("."),a=JSON.parse(atob(i[1])).nonce,c=t.id_token.split("."),u=JSON.parse(atob(c[1]));u.nonce=a;var f=btoa(JSON.stringify(u)),l=c[0]+"."+f+"."+c[2],p=btoa(JSON.stringify({tokenID:l,tokenIDJSON:n}));o({assertion:p,idp:{domain:"google.com",protocol:"OIDC"},info:s,infoToken:r})})})})})},l=function(e,n,o){console.log("[IDPROXY.generateAssertion:contents]",e),console.log("[IDPROXY.generateAssertion:origin]",n),console.log("[IDPROXY.generateAssertion:hint]",o);var r=c;return new Promise(function(n,u){if(o){t(o,"access_token"),t(o,"id_token");var f=t(o,"code");console.log("GOOGLE_PROXY_HINT: ",o),function(e){var n=c.tokenEndpoint+"code="+e+"&client_id="+c.clientID+"&client_secret="+c.clientSecret+"&redirect_uri="+c.redirectURI+"&grant_type=authorization_code&access_type="+c.accessType;return new Promise(function(e,o){i("POST",n).then(function(n){console.log("[IDPROXY.exchangeCode:info]",n),e(n)},function(e){o(e)})})}(f).then(function(e){i("GET",r.userinfo+e.access_token).then(function(o){var t={accessToken:e.access_token,idToken:e.id_token,refreshToken:e.refresh_token,tokenType:e.token_type,infoToken:o};i("GET",r.tokenInfo+e.id_token).then(function(i){t.tokenIDJSON=i,t.expires=i.exp,t.email=i.email;var r={assertion:btoa(JSON.stringify({tokenID:e.id_token,tokenIDJSON:i})),idp:{domain:"google.com",protocol:"OIDC"},info:t,infoToken:o};s[a]=r,++a,console.log("[IDPROXY.generateAssertion:returnValue]",JSON.stringify(r)),n(r)},function(e){u(e)})},function(e){u(e)})},function(e){u(e)})}else{console.log("GOOGLE_PROXY_NO_HINT: ",l);var l=r.authorisationEndpoint+"scope="+r.scope+"&client_id="+r.clientID+"&redirect_uri="+r.redirectURI+"&response_type=code&state="+r.state+"&prompt=consent&access_type="+r.accessType+"&nonce="+e;u({name:"IdPLoginError",loginUrl:l})}})},p=function(){function e(n,o,t){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e);var i=this;i.runtimeProtoStubURL=n,i.messageBus=o,i.config=t,console.log("Google->Google constructor"),i.messageBus.addListener("*",function(e){"domain-idp://google.com"===e.to&&i.requestToIdp(e)}),i._sendStatus("created")}return r(e,[{key:"requestToIdp",value:function(e){var n=this,o=e.body.params;switch(e.body.method){case"generateAssertion":console.info("generateAssertion"),l(o.contents,o.origin,o.usernameHint).then(function(o){n.replyMessage(e,o)},function(o){n.replyMessage(e,o)});break;case"validateAssertion":console.info("validateAssertion"),u(o.assertion,o.origin).then(function(o){n.replyMessage(e,o)},function(o){n.replyMessage(e,o)});break;case"refreshAssertion":console.info("refreshAssertion"),f(o.identity).then(function(o){n.replyMessage(e,o)},function(o){n.replyMessage(e,o)})}}},{key:"replyMessage",value:function(e,n){var o={id:e.id,type:"response",to:e.from,from:e.to,body:{code:200,value:n}};this.messageBus.postMessage(o)}},{key:"_sendStatus",value:function(e,n){console.log("[GoogleIdpProxy.sendStatus] ",e),this._state=e;var o={type:"update",from:this.runtimeProtoStubURL,to:this.runtimeProtoStubURL+"/status",body:{value:e}};n&&(o.body.desc=n),this.messageBus.postMessage(o)}}]),e}()}]).default});