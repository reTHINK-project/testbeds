!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("activate",[],t):"object"==typeof exports?exports.activate=t():e.activate=t()}("undefined"!=typeof self?self:this,function(){return function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}return o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=0)}([function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,o){return{name:"EdpIdpProxyProtoStub",instance:new s(e,t,o)}};var n=o(1),r=o(2),i=function(e){return e&&e.__esModule?e:{default:e}}(o(3));var s=function(e){function t(e,o,i){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),i.domain="edpdistribuicao.pt",i.idpUrl="domain-idp://edpdistribuicao.pt",i.idpProxy=n.IdpProxy,i.idpInfo=r.edpInfo,i.apiInfo=r.edpInfo,i.authEndpoint=r.authEndpoint,i.accessTokenInput=r.accessTokenInput,i.accessTokenEndpoint=r.authEndpoint,function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,o,i))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,i.default),t}()},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});location.protocol,location.hostname,""!==location.port&&location.port;var n=void 0,r=void 0;function i(e,t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var o=new RegExp("[\\#&?]"+t+"=([^&#]*)").exec(e);return null!==o&&o[1]}t.IdpProxy={getAccessTokenAuthorisationEndpoint:function(e,t){return console.log("[Edp.IdpProxy.getAccessTokenAuthorisationEndpoint:config]",e),console.log("[Edp.IdpProxy.getAccessTokenAuthorisationEndpoint:resources]",t),r=e.authEndpoint,new Promise(function(e,o){e(r(t))},function(e){reject(e)})},getAccessToken:function(e,t,o){return console.log("[OIDC.getAccessToken:config]",e),console.log("[OIDC.getAccessToken:login]",o),e.accessTokenEndpoint,n=e.domain,new Promise(function(e,r){var s="true"===i(o,"isValid"),c="true"===i(o,"consent");if(c&s){var u=c,a=31536e5+Math.floor(Date.now()/1e3);e(function(e,t,o,r,i){var s={domain:n,resources:e,accessToken:t,expires:o,input:r};return i&&(s.refresh=i),s}(t,u,a,o))}else r({consent:c,isValid:s})},function(e){reject(e)})}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.authEndpoint=function(e){return r.authorisationEndpoint+"client_id="+e+"&redirect_uri="+n},t.revokeEndpoint=function(e){return r.revokeEndpoint+"client_id="+e},t.accessTokenInput=function(e){return{info:e}};var n=location.protocol+"//"+location.hostname+(""!==location.port?":"+location.port:""),r=t.edpInfo={authorisationEndpoint:"https://online.edpdistribuicao.pt/sharing-cities/login?",revokeEndpoint:"https://online.edpdistribuicao.pt/sharing-cities/revoke?",domain:"edpdistribuicao.pt"}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,o,n){return o&&e(t.prototype,o),n&&e(t,n),t}}();var r=void 0,i=void 0,s=void 0,c=function(){function e(t,o,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var c=this;c.runtimeProtoStubURL=t,c.messageBus=o,c.config=n,r=n.idpProxy,i=n.convertUserProfile,s=n.accessTokenInput,console.log("[AbstractIdpProxy] constructor"),c.messageBus.addListener("*",function(e){e.to===n.idpUrl&&c.requestToIdp(e)}),c._sendStatus("created")}return n(e,[{key:"requestToIdp",value:function(e){var t=this,o=e.body.params;switch(console.info("[AbstractIdpProxyProtoStub] receiving request: ",e),e.body.method){case"generateAssertion":r.generateAssertion(t.config,o.contents,o.origin,o.usernameHint).then(function(o){o.userProfile=i(o.userProfile),t.replyMessage(e,o)},function(o){t.replyMessage(e,o,401)});break;case"validateAssertion":r.validateAssertion(t.config,o.assertion,o.origin).then(function(o){t.replyMessage(e,o)},function(o){t.replyMessage(e,o)});break;case"refreshAssertion":r.refreshAssertion(o.identity).then(function(o){t.replyMessage(e,o)},function(o){t.replyMessage(e,o,value,401)});break;case"getAccessTokenAuthorisationEndpoint":r.getAccessTokenAuthorisationEndpoint(t.config,o.resources).then(function(o){t.replyMessage(e,o)},function(o){t.replyMessage(e,o,401)});break;case"getAccessToken":r.getAccessToken(t.config,o.resources,o.login).then(function(o){console.info("OIDC.getAccessToken result: ",o),o.input=s(o.input),t.replyMessage(e,o)},function(o){t.replyMessage(e,o,401)});break;case"refreshAccessToken":r.refreshAccessToken(t.config,o.token).then(function(o){console.info("OIDC.refreshAccessToken result: ",o),t.replyMessage(e,o)},function(o){t.replyMessage(e,o,401)})}}},{key:"replyMessage",value:function(e,t){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:200,n={id:e.id,type:"response",to:e.from,from:e.to,body:{code:o}};o<300?n.body.value=t:n.body.description=t,console.log("[AbstractIdpProxyProtoStub.replyMessage] ",n),this.messageBus.postMessage(n)}},{key:"_sendStatus",value:function(e,t){console.log("[AbstractIdpProxyProtoStub.sendStatus] ",e),this._state=e;var o={type:"update",from:this.runtimeProtoStubURL,to:this.runtimeProtoStubURL+"/status",body:{value:e}};t&&(o.body.desc=t),this.messageBus.postMessage(o)}}]),e}();t.default=c}]).default});