!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define("activate",[],n):"object"==typeof exports?exports.activate=n():e.activate=n()}("undefined"!=typeof self?self:this,function(){return function(e){var n={};function t(o){if(n[o])return n[o].exports;var s=n[o]={i:o,l:!1,exports:{}};return e[o].call(s.exports,s,s.exports,t),s.l=!0,s.exports}return t.m=e,t.c=n,t.d=function(e,n,o){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:o})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=0)}([function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.default=function(e,n,t){return{name:"SlackProxyStub",instance:new i(e,n,t)}};var o=t(1),s=t(2),r=function(e){return e&&e.__esModule?e:{default:e}}(t(3));var i=function(e){function n(e,t,r){return function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,n),r.idpUrl="domain-idp://slack.com",r.idpProxy=o.IdpProxy,r.domain="slack.com",r.convertUserProfile=s.convertUserProfile,r.userInfoEndpoint=s.userInfoEndpoint,r.validateAssertionEndpoint=s.validateAssertionEndpoint,r.authorisationEndpoint=s.authorisationEndpoint,r.tokenEndpoint=s.tokenEndpoint,r.accessTokenAuthorisationEndpoint=s.accessTokenAuthorisationEndpoint,r.accessTokenEndpoint=s.accessTokenEndpoint,r.accessTokenInput=s.accessTokenInput,function(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e,t,r))}return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}(n,r.default),n}()},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=void 0,s=void 0,r=void 0,i=void 0,c=void 0,a=void 0;function u(e,n){n=n.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\#&?]"+n+"=([^&#]*)").exec(e);return null===t?"":t[1]}function l(e,n){var t=new XMLHttpRequest;return"withCredentials"in t?t.open(e,n,!0):"undefined"!=typeof XDomainRequest?(t=new XDomainRequest).open(e,n):t=null,new Promise(function(e,n){t?(t.onreadystatechange=function(o){if(4===t.readyState)if(200===t.status){var s=JSON.parse(t.responseText);e(s)}else 400===t.status?n("There was an error processing the token"):n("something else other than 200 was returned")},t.send()):n("CORS not supported")})}var p=function(e,n,t){return new Promise(function(s,r){l("GET",o(t)).then(function(o){console.log("[OAUTH2.generateAssertion] obtained user profile ",o);var r=btoa(JSON.stringify({tokenID:t.access_token,tokenIDJSON:o,publicKey:e}));console.log("[OAUTH2.generateAssertion] atob assertion:",atob(r));var c={assertion:r,idp:{domain:i,protocol:"OAUTH2"},expires:n,userProfile:o};console.log("[OAUTH2.generateAssertion] returning: ",JSON.stringify(c)),s(c)})})},f=n.getExpires=function(e){var n=u(e,"expires_in");return n?n+=Math.floor(Date.now()/1e3):n=31536e5+Math.floor(Date.now()/1e3),n},d=function(e,n,t,o,s){var r={domain:i,resources:e,accessToken:n,expires:t,input:o};return s&&(r.refresh=s),r};n.IdpProxy={validateAssertion:function(e,n,t){return console.info("[OAUTH2.validateAssertion] assertion: ",atob(n)),o=e.userInfoEndpoint,i=e.domain,new Promise(function(t,o){var s=atob(n),r=JSON.parse(s);l("GET",e.validateAssertionEndpoint({access_token:r.tokenID,input:r.tokenIDJSON})).then(function(n){JSON.stringify(n)===JSON.stringify(r.tokenIDJSON)?t({identity:e.convertUserProfile(n).id,contents:r.publicKey}):o("invalid")}).catch(function(e){o(e)})})},generateAssertion:function(e,n,t,c){console.log("[OAUTH2.generateAssertion:config]",e),console.log("[OAUTH2.generateAssertion:contents]",n),console.log("[OAUTH2.generateAssertion:origin]",t),console.log("[OAUTH2.generateAssertion:hint]",c),o=e.userInfoEndpoint,s=e.tokenEndpoint,r=e.authorisationEndpoint,i=e.domain;return new Promise(function(e,t){if(c){var o=u(c,"expires_in");o?o+=Math.floor(Date.now()/1e3):o=31536e5+Math.floor(Date.now()/1e3);var i=u(c,"access_token");e(i?p(n,o,{access_token:i}):function(e,n,t){return new Promise(function(o,r){var i=u(t,"code");i||r("[OAUTH2.generateAssertionWithCode] code not returned by the authentication: ",t),l("POST",s(i)).then(function(t){t.hasOwnProperty("access_token")?o(p(e,n,t)):r("[OAUTH2.generateAssertionWithCode] access token not returned in the exchange code result: ",t)},function(e){r(e)})})}(n,o,c))}else t({name:"IdPLoginError",loginUrl:r(n)})},function(e){reject(e)})},getAccessTokenAuthorisationEndpoint:function(e,n){console.log("[OAUTH2.getAccessTokenAuthorisationEndpoint:config]",e),console.log("[OAUTH2.getAccessTokenAuthorisationEndpoint:resources]",n),a=e.accessTokenAuthorisationEndpoint;return new Promise(function(e,t){e(a(n))},function(e){reject(e)})},getAccessToken:function(e,n,t){console.log("[OAUTH2.getAccessToken:config]",e),console.log("[OAUTH2.getAccessToken:login]",t),c=e.accessTokenEndpoint,i=e.domain;return new Promise(function(e,o){var s=f(t),r=u(t,"access_token");e(r?d(n,r,s,t):function(e,n){return new Promise(function(t,o){var s=u(n,"code");s||o("[OAUTH2.getAccessTokenWithCodeToken] code not returned by the login result: ",n),l("POST",c(s)).then(function(n){if(n.hasOwnProperty("access_token")){var s=f(n);t(d(e,n.access_token,s,n))}else o("[OAUTH2.getAccessTokenWithCodeToken] access token not returned in the exchange code result: ",n)},function(e){o(e)})})}(n,t))},function(e){reject(e)})}}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.convertUserProfile=function(e){console.log("[SlackUserProfileConverter] ",e);var n=e.user.profile;n.userURL="user://slack.com/"+e.user.name,n.picture=n.image_original?n.image_original:n.image_72,n.id=e.user.id,n.hasOwnProperty("preferred_username")||(n.preferred_username=e.user.name);return n.name=e.user.name,n},n.accessTokenInput=function(e){return console.log("[Slack.getAccessTokenInput] from ",e),{user_id:e.user_id,team_id:e.team_id}},n.userInfoEndpoint=function(e){return r.userinfo+e.access_token+"&user="+e.user_id},n.validateAssertionEndpoint=function(e){return r.userinfo+e.access_token+"&user="+e.input.user.id},n.authorisationEndpoint=function(e){var n=r.authorisationEndpoint+"redirect_uri="+o+"&response_type="+r.type+"&client_id="+r.clientID+"&scope="+r.scope+"&access_type="+r.accessType+"&state="+e;return console.log("[Slack.authorisationEndpoint] ",n),n},n.tokenEndpoint=function(e){return r.tokenEndpoint+"client_id="+r.clientID+"&client_secret="+r.clientSecret+"&code="+e+"&redirect_uri="+o},n.accessTokenAuthorisationEndpoint=function(){var e=s.authorisationEndpoint+"redirect_uri="+o+"&response_type="+s.type+"&client_id="+s.clientID+"&scope="+s.scope+"&access_type="+s.accessType+"&state="+s.state;return console.log("[Slack.accessTokenAuthorisationEndpoint] ",e),e},n.accessTokenEndpoint=function(e){return s.tokenEndpoint+"client_id="+s.clientID+"&client_secret="+s.clientSecret+"&code="+e+"&redirect_uri="+o};var o=location.protocol+"//"+location.hostname+(""!==location.port?":"+location.port:""),s={clientID:"11533603872.72434934356",authorisationEndpoint:"https://slack.com/oauth/authorize?",userinfo:"https://slack.com/api/users.info?token=",type:"token",granted_scopes:"client",state:"state",accessType:"online",tokenEndpoint:"https://slack.com/api/oauth.access?",scope:"client",clientSecret:"d427ef3c957d68a292dc7c4e20b78330"},r={clientID:"11533603872.291565187299",authorisationEndpoint:"https://slack.com/oauth/authorize?",userinfo:"https://slack.com/api/users.info?token=",type:"token",granted_scopes:"identity.basic,identity.avatar,identity.email",state:"state",accessType:"online",tokenEndpoint:"https://slack.com/api/oauth.access?",scope:"client",clientSecret:"721ee11eb303817b6b8ee41b785746de"}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}();var s=void 0,r=void 0,i=void 0,c=function(){function e(n,t,o){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e);var c=this;c.runtimeProtoStubURL=n,c.messageBus=t,c.config=o,s=o.idpProxy,r=o.convertUserProfile,i=o.accessTokenInput,console.log("[AbstractIdpProxy] constructor"),c.messageBus.addListener("*",function(e){e.to===o.idpUrl&&c.requestToIdp(e)}),c._sendStatus("created")}return o(e,[{key:"requestToIdp",value:function(e){var n=this,t=e.body.params;switch(console.info("[AbstractIdpProxyProtoStub] receiving request: ",e),e.body.method){case"generateAssertion":s.generateAssertion(n.config,t.contents,t.origin,t.usernameHint).then(function(t){t.userProfile=r(t.userProfile),n.replyMessage(e,t)},function(t){n.replyMessage(e,t,401)});break;case"validateAssertion":s.validateAssertion(n.config,t.assertion,t.origin).then(function(t){n.replyMessage(e,t)},function(t){n.replyMessage(e,t)});break;case"refreshAssertion":s.refreshAssertion(t.identity).then(function(t){n.replyMessage(e,t)},function(t){n.replyMessage(e,t,value,401)});break;case"getAccessTokenAuthorisationEndpoint":s.getAccessTokenAuthorisationEndpoint(n.config,t.resources).then(function(t){n.replyMessage(e,t)},function(t){n.replyMessage(e,t,401)});break;case"getAccessToken":s.getAccessToken(n.config,t.resources,t.login).then(function(t){console.info("OIDC.getAccessToken result: ",t),t.input=i(t.input),n.replyMessage(e,t)},function(t){n.replyMessage(e,t,401)});break;case"refreshAccessToken":s.refreshAccessToken(n.config,t.token).then(function(t){console.info("OIDC.refreshAccessToken result: ",t),n.replyMessage(e,t)},function(t){n.replyMessage(e,t,401)})}}},{key:"replyMessage",value:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:200,o={id:e.id,type:"response",to:e.from,from:e.to,body:{code:t}};t<300?o.body.value=n:o.body.description=n,console.log("[AbstractIdpProxyProtoStub.replyMessage] ",o),this.messageBus.postMessage(o)}},{key:"_sendStatus",value:function(e,n){console.log("[AbstractIdpProxyProtoStub.sendStatus] ",e),this._state=e;var t={type:"update",from:this.runtimeProtoStubURL,to:this.runtimeProtoStubURL+"/status",body:{value:e}};n&&(t.body.desc=n),this.messageBus.postMessage(t)}}]),e}();n.default=c}]).default});