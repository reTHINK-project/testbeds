!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("activate",[],t):"object"==typeof exports?exports.activate=t():e.activate=t()}("undefined"!=typeof self?self:this,function(){return function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:o})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,n,o){return{name:"GoogleProtoStub",instance:new u(e,t,n,o)}};var o=n(1);function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function s(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var u=function(e){function t(e,n,o,r){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),s(this,a(t).call(this,e,n,o,r,"GoogleProtoStub"))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(t,o["a"]),function(e,t,n){t&&i(e.prototype,t),n&&i(e,n)}(t,[{key:"querySessions",value:function(e,t){var n=this;e!==t&&(e=t);var o=new Date,r=o.toISOString(),i=o.getTime(),s=new Date(e).getTime();(new XMLHttpRequest).withCredentials=!0,n.getDistanceForActivities(s,i).then(function(e){for(var t=0;t<e.length;t+=1){var o=e[t],i=o.activity,a=o.dataset[0].point[0].value[0].fpVal,c=new Date(s).toISOString();switch(i){case 7:case 8:console.log("[GoogleProtoStub] walking/running distance (m): ",a),n.writeToReporter("walk",a,c,r);break;case 1:console.log("[GoogleProtoStub] biking distance (m): ",a),n.writeToReporter("bike",a,c,r)}}},function(o){if(o.hasOwnProperty("errorCode")&&401===o.errorCode)return n.refreshAccessToken(e,t,"google.com");throw o}).catch(function(e){n._sendStatus("disconnected",e),console.error("[GoogleProtoStub.querySessions] error: ",e)})}},{key:"getDistanceForActivities",value:function(e,t){var n=this;return new Promise(function(o,r){var i={aggregateBy:[{dataTypeName:"com.google.distance.delta"}],bucketByActivityType:{minDurationMillis:0},startTimeMillis:e,endTimeMillis:t},s=new XMLHttpRequest;s.withCredentials=!0,s.addEventListener("readystatechange",function(){if(4===this.readyState){var e=JSON.parse(this.responseText);console.log("[GoogleProtoStub.getDistanceForActivities] response: ",e),e.hasOwnProperty("bucket")?o(e.bucket):e.hasOwnProperty("code")&&e.code>299?r({errorCode:e.code}):r(e)}}),s.open("POST","https://www.googleapis.com/fitness/v1/users/me/dataset:aggregate"),s.setRequestHeader("Content-Type","application/json"),s.setRequestHeader("Authorization","Bearer "+n._accessToken),s.setRequestHeader("Cache-Control","no-cache"),s.send(JSON.stringify(i))})}}]),t}()},function(e,t,n){"use strict";function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}n.d(t,"a",function(){return r});var r=function(){function e(t,n,o,r,i){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._stubName=i,!t)throw new Error("The runtimeProtoStubURL is a needed parameter");if(!n)throw new Error("The bus is a needed parameter");if(!o)throw new Error("The config is a needed parameter");if(!o.runtimeURL)throw new Error("The config.runtimeURL is a needed parameter");var s=this;console.log("[".concat(this._stubName,"] PROTOSTUB"),s),this._id=0,this._runtimeProtoStubURL=t,this._bus=n,this._config=o,this._domain=o.domain,this._runtimeSessionURL=o.runtimeURL,this._syncher=r.createSyncher(t,n,o),this._userActivityVertxHypertyURL="hyperty://sharing-cities-dsm/user-activity",s._sendStatus("created"),s.started=!1;n.addListener("*",function(e){if(console.log("".concat(s._stubName," new Message  : "),e),e.identity&&(s._identity=e.identity),"delete"!==e.type){if(e.hasOwnProperty("body")&&e.body.hasOwnProperty("identity")){if(e.body.identity.accessToken){s._accessToken=e.body.identity.accessToken;var t={id:e.id,type:"response",from:e.to,to:e.from,body:{code:200,runtimeURL:s._runtimeSessionURL}};console.log(s),s._bus.postMessage(t)}s.hypertyJSUrl=e.from}var n="hyperty-catalogue://catalogue."+s._domain+"/.well-known/dataschema/Context",o={id:"1276020076",values:[{type:"user_walking_context",name:"walking distance in meters",unit:"meter",value:0,startTime:"2018-03-25T12:00:00Z",endTime:"2018-03-25T12:10:00Z"},{type:"user_biking_context",name:"biking distance in meters",unit:"meter",value:0,startTime:"2018-03-26T12:00:00Z",endTime:"2018-03-26T12:10:00Z"}]};s._accessToken&&!s.started&&"create"===e.type&&s._resumeReporters("user_activity",e.to).then(function(t){console.log("[".concat(s._stubName,"._resumeReporters (result)  "),t),0==t?s._setUpReporter(s._identity,n,o,["context"],"user_activity",e.to).then(function(e){e&&s.startWorking(e,!1)}):s.startWorking(t,!0)}).catch(function(e){})}else s.stopWorking()})}return function(e,t,n){t&&o(e.prototype,t),n&&o(e,n)}(e,[{key:"startWorking",value:function(e,t){var n=this;function o(){var t=e.metadata.created,o=e.metadata.lastModified;o||(o=t),n.querySessions(t,o),n.startInterval=setInterval(function(){(o=e.metadata.lastModified)||(o=t),n.querySessions(t,o)},n.config.sessions_query_interval),n.started=!0}n.reporter=e,n.hasStartedQuerying=!1,t&&(n.hasStartedQuerying=!0,o()),e.onSubscription(function(e){e.accept(),console.log("".concat(n._stubName," new subs"),e),n.hasStartedQuerying||(n.hasStartedQuerying=!0,o())}),console.log("".concat(n._stubName," User activity DO created: "),e),e.inviteObservers([n._userActivityVertxHypertyURL])}},{key:"stopWorking",value:function(){clearInterval(this.startInterval),this.started=!1}},{key:"_setUpReporter",value:function(e,t,n,o,r,i){var s=this;return new Promise(function(a,c){var u={resources:o,expires:3600,reporter:i,domain_registration:!1,domain_routing:!1};s._syncher.create(t,[],n,!0,!1,r,e,u).then(function(e){console.log("".concat(s._stubName," REPORTER RETURNED"),e),a(e)}).catch(function(e){console.error("".concat(s._stubName," err"),e),a(null)})})}},{key:"_resumeReporters",value:function(e,t){var n=this;return new Promise(function(o,r){n._syncher.resumeReporters({store:!0,reporter:t}).then(function(r){console.log("[".concat(n._stubName," Reporters resumed"),r);var i=Object.keys(r);if(!(i.length>0))return o(!1);i.forEach(function(i){if(console.log("[".concat(n._stubName),i),console.log("[".concat(n._stubName),r[i]),t==r[i].metadata.reporter&&r[i].metadata.name==e)return o(r[i])})}).catch(function(e){console.info("[".concat(n._stubName," Reporters:"),e)})})}},{key:"querySessions",value:function(e,t){}},{key:"writeToReporter",value:function(e,t,n,o){var r,i;"bike"===e?(r="user_biking_context",i="biking distance in meters"):"walk"===e&&(r="user_walking_context",i="walking distance in meters"),this.reporter.data.values=[{type:r,name:i,unit:"meter",value:t,startTime:n,endTime:o}]}},{key:"refreshAccessToken",value:function(e,t,n){var o=this;return new Promise(function(r,i){var s={type:"execute",from:o._runtimeProtoStubURL,to:o._runtimeSessionURL+"/idm",body:{method:"refreshAccessToken",params:{resources:["user_activity_context"],domain:n}}};o._bus.postMessage(s,function(n){console.log("[".concat(o._stubName,".refreshAccessToken] reply "),n),n.body.hasOwnProperty("value")?(o._accessToken=n.body.value,o.querySessions(e,t),r()):i(n.body)})})}},{key:"_sendStatus",value:function(e,t){console.log("[[".concat(this._stubName,"] status changed] to "),e),this._state=e;var n={type:"update",from:this._runtimeProtoStubURL,to:this._runtimeProtoStubURL+"/status",body:{value:e}};t&&(n.body.desc=t),this._bus.postMessage(n)}},{key:"config",get:function(){return this._config}},{key:"runtimeSession",get:function(){return this._runtimeSessionURL}}]),e}()}]).default});